---
format:
  pdf:
    pdf-engine: pdflatex
    documentclass: article
    geometry:
      - top=30mm
      - left=25mm
      - right=25mm
      - bottom=30mm
    include-in-header:
      text: |
        \setlength{\parindent}{0pt}
        \setlength{\parskip}{6pt}
        \setlength{\leftmargini}{1.2em}
---

```{python}
#| echo: false
#| output: asis
import os
import json

# Get metadata passed from generate_mom.py
mtitle = os.environ.get('QUARTO_MTITLE', '') # Fallback to env if needed or pass via metadata
# Actually, Quarto metadata is not directly in os.environ.
# But I can access the JSON data since I'm already loading it below.

# Let's use the data we are about to load.
# I'll move the data loading to the top of this block.

json_file = os.environ.get('MOM_JSON_FILE', 'minit_exco_1_22.json')
with open(json_file, 'r') as f:
    data = json.load(f)

if isinstance(data, list) and len(data) > 0:
    data = data[0]

# Compute title and metadata
jenis = data.get("Jenis", "agm")
if jenis == "exco":
    title_text = "MINIT MESYUARAT JAWATANKUASA EKSEKUTIF"
else:
    title_text = "MINIT MESYUARAT AGUNG TAHUNAN"

siri = data.get("Siri", "N/A")
tarikh = data.get("Tarikh", "N/A")
year_part = tarikh.split("/")[-1] if "/" in tarikh else "2025"
tahun = year_part if len(year_part) == 4 else "20" + year_part

# Check format
is_pdf = os.environ.get('QUARTO_FORMAT') == 'pdf'
# Or more reliably:
print(f'::: {{.content-visible when-format="pdf"}}')
print(f'\\begin{{center}}')
print(f'\\includegraphics[width=\\textwidth]{{logo.png}}\n')
print(f'\\Large\\textbf{{{title_text}}}\n')
print(f'\\large Siri {siri}/{tahun} pada {tarikh}')
print(f'\\end{{center}}')
print(f':::')

print(f'::: {{.content-visible unless-format="pdf"}}')
print(f'<div align="center">')
print(f'![](logo.png){{width=100%}}\n')
print(f'# {title_text}')
print(f'### Siri {siri}/{tahun} pada {tarikh}')
print(f'</div>')
print(f':::')
```


```{python}
#| echo: false
#| output: asis

def get_case_insensitive(d, key, default=None):
    if not isinstance(d, dict):
        return default
    for k, v in d.items():
        if k.lower() == key.lower():
            return v
    return default

import re

def format_keterangan(text):
    if not isinstance(text, str):
        return text
    
    lines = text.split('\n')
    new_lines = []
    i = 0
    in_ajk_table = False
    while i < len(lines):
        line = lines[i].strip()
        # Look for table title row: | TITLE | | |
        # It should be followed by a separator line: |---|---|---|
        if line.startswith('|') and line.endswith('|'):
            cells = [c.strip() for c in line.split('|')[1:-1]]
            # If it's a multi-column row with only the first cell filled (table title)
            if len(cells) > 1 and all(c == '' for c in cells[1:]):
                title = cells[0]
                # Check if this is a header row followed by a separator
                if i + 1 < len(lines) and re.match(r'^\|[\s:-]*\|', lines[i+1].strip()):
                    # Reconstruct the table: Move title to its own paragraph, 
                    # use i+2 as header and i+1 as separator
                    if i + 2 < len(lines) and lines[i+2].strip().startswith('|'):
                        new_lines.append(f"\n\n\\begin{{center}} {title} \\end{{center}}\n\n")
                        header_row = lines[i+2]
                        new_lines.append(header_row) # New header
                        new_lines.append(lines[i+1]) # Separator
                        
                        # Detect if this is the AJK table
                        if "Siri" in header_row and "Nama" in header_row and "Jawatan" in header_row:
                            in_ajk_table = True
                        
                        i += 3
                        continue
        
        if in_ajk_table:
            if not line.startswith('|'):
                new_lines.append(': {tbl-colwidths="[10, 65, 25]"}\n\n')
                in_ajk_table = False
        
        new_lines.append(lines[i])
        i += 1
    
    # Handle case where table is the last thing in the text
    if in_ajk_table:
        new_lines.append(': {tbl-colwidths="[10, 65, 25]"}\n\n')
        
    return '\n'.join(new_lines)



# --- HADIR ---
print("### HADIR")
hadir = data.get('Hadir', {})
if isinstance(hadir, str):
    print(hadir)
elif isinstance(hadir, dict):
    nama_list = get_case_insensitive(hadir, 'nama', [])
    jawatan_list = get_case_insensitive(hadir, 'jawatan', [])
    if nama_list:
        print("| Name | Designation |")
        print("| --- | --- |")
        for i in range(len(nama_list)):
            nama = nama_list[i] if i < len(nama_list) else ""
            jawatan = jawatan_list[i] if i < len(jawatan_list) else ""
            print(f"| {nama} | {jawatan} |")
    else:
        print("Tiada rekod kehadiran berstruktur.")
else:
    print("Tiada maklumat kehadiran.")

# --- TIDAK HADIR ---
tidak_hadir = get_case_insensitive(data, 'tidak hadir (dengan maaf)', {})
if tidak_hadir:
    print("\n### TIDAK HADIR (DENGAN MAAF)")
    if isinstance(tidak_hadir, str):
        print(tidak_hadir)
    elif isinstance(tidak_hadir, dict):
        t_nama_list = get_case_insensitive(tidak_hadir, 'nama', [])
        t_jawatan_list = get_case_insensitive(tidak_hadir, 'jawatan', [])
        if t_nama_list:
            print("| Name | Designation |")
            print("| --- | --- |")
            for i in range(len(t_nama_list)):
                nama = t_nama_list[i] if i < len(t_nama_list) else ""
                jawatan = t_jawatan_list[i] if i < len(t_jawatan_list) else ""
                print(f"| {nama} | {jawatan} |")
        else:
            print("Tiada rekod tidak hadir berstruktur.")

print("\n---\n")

# --- AGENDA ---
agenda_data = data.get('Agenda', {})
agenda_items = []

if isinstance(agenda_data, dict) and agenda_data:
    # Handle nested Agenda: {"1": {...}, "2": {...}}
    for key in sorted(agenda_data.keys(), key=lambda x: int(x) if x.isdigit() else 999):
        agenda_items.append(agenda_data[key])
else:
    # Handle flat keys: "Agenda_1", "Agenda_2"
    agenda_keys = sorted([k for k in data.keys() if k.startswith('Agenda_')], 
                        key=lambda x: int(x.split('_')[1]) if x.split('_')[1].isdigit() else 999)
    for k in agenda_keys:
        agenda_items.append(data[k])

for i, item in enumerate(agenda_items, 1):
    perkara = get_case_insensitive(item, 'perkara', '').upper()
    print(f"### AGENDA {i}: {perkara}")
    
    keterangan = get_case_insensitive(item, 'keterangan', '')
    formatted_keterangan = format_keterangan(keterangan)
    if isinstance(formatted_keterangan, list):
        for k in formatted_keterangan:
            print(f"{k}")
    else:
        import re
        # Split into blocks by double newlines to keep tables/LaTeX intact
        for block in formatted_keterangan.split('\n\n'):
            block = block.strip()
            if not block: continue
            
            is_table = block.startswith('|')
            is_raw_latex = block.startswith('\\')
            is_attribute = block.startswith(':')
            
            if is_table or is_raw_latex:
                print(f"\n{block}\n")
            elif is_attribute:
                print(f"{block}\n")
            else:
                # Normal paragraph or list, might have manual line breaks
                for line in block.split('\n'):
                    line = line.strip()
                    if not line: continue
                    is_level2 = re.match(r'^\([0-9]+\)', line)
                    is_manual_list = re.match(r'^(\(?[a-z0-9]+\s*[.)]|\*|-|\+)', line, re.IGNORECASE)
                    
                    if is_level2:
                        print(f"        {line}  ") # 8 spaces
                    elif is_manual_list:
                        print(f"    {line}  ")     # 4 spaces aligns with "1. "
                    elif not line.startswith('@.'):
                        print(f"@.  {line}  ")
                    else:
                        print(f"{line}  ")
    
    keputusan = get_case_insensitive(item, 'keputusan', '')
    if keputusan:
        if isinstance(keputusan, str):
            import re
            # Also handle blocks/lines in Keputusan
            for block in keputusan.split('\n\n'):
                block = block.strip()
                if not block: continue
                lines = block.split('\n')
                first = True
                for line in lines:
                    line = line.strip()
                    if not line: continue
                    is_level2 = re.match(r'^\([0-9]+\)', line)
                    is_manual_list = re.match(r'^(\(?[a-z0-9]+\s*[.)]|\*|-|\+)', line, re.IGNORECASE)
                    if first:
                        print(f"\n@.    **Keputusan:** {line}  ")
                        first = False
                    elif is_level2:
                        print(f"            {line}  ") # 12 spaces
                    elif is_manual_list:
                        print(f"        {line}  ")    # 8 spaces aligns with text after "Keputusan: "
                    else:
                        print(f"      {line}  ")
        else:
            print(f"\n@.    **Keputusan:** {keputusan}  ")
    
    print("\n")

print("\n---\n")

# --- PENUTUP ---
print(f"### PENUTUP")
print(data.get('Penutup', ''))

print("\n\n")

# --- SIGNATORIES ---
# Try multiple common keys for Disediakan/Diluluskan
disediakan = get_case_insensitive(data, 'disediakan oleh', get_case_insensitive(data, 'disediakan', '....................'))
diluluskan = get_case_insensitive(data, 'diluluskan oleh', get_case_insensitive(data, 'diluluskan', '....................'))

print(f"**Disediakan Oleh:**  ")
print(f"{disediakan}  ")
print(f"\n**Diluluskan Oleh:**  ")
print(f"{diluluskan}")
```
